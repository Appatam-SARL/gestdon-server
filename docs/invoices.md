# SystÃ¨me de Factures d'Abonnement

## Vue d'ensemble

Le systÃ¨me de factures permet de gÃ©nÃ©rer, stocker et tÃ©lÃ©charger des factures **PDF** et **HTML** pour les abonnements. Les factures sont gÃ©nÃ©rÃ©es dynamiquement Ã  partir des donnÃ©es de souscription et stockÃ©es sur le serveur.

## ðŸ†• **NouveautÃ©s**

- âœ… **GÃ©nÃ©ration PDF** : Les factures sont maintenant gÃ©nÃ©rÃ©es en PDF par dÃ©faut
- âœ… **Support HTML** : PossibilitÃ© de gÃ©nÃ©rer des factures HTML sur demande
- âœ… **Conversion automatique** : HTML vers PDF avec Puppeteer
- âœ… **Performance optimisÃ©e** : Configuration Puppeteer pour la production

## FonctionnalitÃ©s

- âœ… GÃ©nÃ©ration automatique de factures PDF/HTML
- âœ… Stockage local sur le serveur
- âœ… TÃ©lÃ©chargement et prÃ©visualisation
- âœ… Gestion des templates personnalisables
- âœ… Nettoyage automatique des anciennes factures
- âœ… Validation des donnÃ©es
- âœ… SÃ©curisation des routes
- âœ… **Conversion HTML â†’ PDF avec Puppeteer**

## Structure des Fichiers

```
src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ invoice.service.ts          # Service principal de gestion des factures
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ invoice.controller.ts       # ContrÃ´leur pour les routes d'API
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ invoice.routes.ts          # Routes pour les factures
â”œâ”€â”€ validations/
â”‚   â””â”€â”€ invoice.validation.ts      # Validation des donnÃ©es
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ invoice.config.ts          # Configuration des factures
â”‚   â””â”€â”€ puppeteer.config.ts        # Configuration Puppeteer
â””â”€â”€ templates/
    â””â”€â”€ invoices/
        â””â”€â”€ subscription-invoice.template.ts  # Template de base
```

## API Endpoints

### Routes Publiques

#### PrÃ©visualiser une facture

```http
GET /api/v1/invoices/:subscriptionId/preview
```

### Routes ProtÃ©gÃ©es (Authentification requise)

#### TÃ©lÃ©charger une facture (PDF par dÃ©faut)

```http
GET /api/v1/invoices/:subscriptionId/download
```

#### TÃ©lÃ©charger une facture en format spÃ©cifique

```http
GET /api/v1/invoices/:subscriptionId/download?format=pdf
GET /api/v1/invoices/:subscriptionId/download?format=html
```

#### RÃ©cupÃ©rer une facture existante

```http
GET /api/v1/invoices/:subscriptionId
```

#### GÃ©nÃ©rer et sauvegarder une facture

```http
POST /api/v1/invoices/:subscriptionId/generate
```

#### Lister toutes les factures (Admin)

```http
GET /api/v1/invoices?page=1&limit=20&sortBy=createdAt&sortOrder=desc
```

#### Supprimer une facture (Admin)

```http
DELETE /api/v1/invoices/:filename
```

#### Nettoyer les anciennes factures (Admin)

```http
POST /api/v1/invoices/cleanup
Body: { "days": 30, "force": false }
```

## Utilisation

### 1. GÃ©nÃ©ration d'une Facture PDF

```typescript
import { InvoiceService } from '../services/invoice.service';

// GÃ©nÃ©rer une facture PDF pour un abonnement
const result = await InvoiceService.generateInvoicePDF(subscriptionId);

if (result.success) {
  const { pdfBuffer, filename, filePath } = result.data;
  console.log('Facture PDF gÃ©nÃ©rÃ©e:', filename);
}
```

### 2. GÃ©nÃ©ration d'une Facture HTML

```typescript
// GÃ©nÃ©rer une facture HTML pour un abonnement
const result = await InvoiceService.generateInvoiceHTML(subscriptionId);

if (result.success) {
  const { htmlContent, filename, filePath } = result.data;
  console.log('Facture HTML gÃ©nÃ©rÃ©e:', filename);
}
```

### 3. TÃ©lÃ©chargement d'une Facture

```typescript
// TÃ©lÃ©charger en PDF (par dÃ©faut)
const response = await fetch(`/api/v1/invoices/${subscriptionId}/download`, {
  headers: {
    Authorization: `Bearer ${token}`,
  },
});

// TÃ©lÃ©charger en HTML
const response = await fetch(
  `/api/v1/invoices/${subscriptionId}/download?format=html`,
  {
    headers: {
      Authorization: `Bearer ${token}`,
    },
  }
);

if (response.ok) {
  if (response.headers.get('content-type')?.includes('pdf')) {
    const blob = await response.blob();
    // Traiter le PDF
  } else {
    const html = await response.text();
    // Traiter le HTML
  }
}
```

### 4. PrÃ©visualisation d'une Facture

```typescript
// Ouvrir dans un nouvel onglet (PDF)
window.open(`/api/v1/invoices/${subscriptionId}/preview`, '_blank');
```

## Configuration

### Variables d'Environnement

```env
# Dossier de stockage des factures
INVOICE_STORAGE_DIR=invoices

# Limite de taille des fichiers (en bytes)
INVOICE_MAX_FILE_SIZE=10485760

# Configuration Puppeteer
PUPPETEER_HEADLESS=true
PUPPETEER_TIMEOUT=30000
```

### Configuration par DÃ©faut

```typescript
export const invoiceConfig = {
  storage: {
    directory: 'invoices',
    maxFileSize: 10 * 1024 * 1024, // 10MB
  },
  billing: {
    currency: 'XOF',
    taxRate: 0.2, // 20% de TVA
  },
  generation: {
    autoSave: true,
    cleanupAfterDays: 30,
    defaultFormat: 'pdf', // Format par dÃ©faut
  },
};
```

### Configuration Puppeteer

```typescript
export const puppeteerConfig = {
  launchOptions: {
    headless: true,
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      // ... autres options d'optimisation
    ],
    timeout: 30000,
  },
  pdfOptions: {
    format: 'A4',
    printBackground: true,
    margin: { top: '20mm', right: '20mm', bottom: '20mm', left: '20mm' },
  },
};
```

## Templates de Factures

### Structure des DonnÃ©es

```typescript
interface InvoiceData {
  invoiceNumber: string;
  invoiceDate: string;
  dueDate: string;
  contributor: {
    name: string;
    email: string;
    address: {
      street: string;
      city: string;
      postalCode: string;
      country: string;
    };
  };
  subscription: {
    packageName: string;
    startDate: string;
    endDate: string;
    duration: string;
    isFreeTrial: boolean;
  };
  billing: {
    subtotal: number;
    tax: number;
    total: number;
    currency: string;
    paymentStatus: string;
  };
}
```

### Personnalisation des Templates

1. Modifier le fichier `src/templates/invoices/subscription-invoice.template.ts`
2. Utiliser les placeholders `{{VARIABLE_NAME}}` pour les donnÃ©es dynamiques
3. Personnaliser le CSS dans la section `<style>`
4. Le CSS sera appliquÃ© lors de la conversion en PDF

## SÃ©curitÃ©

- **Authentification** : La plupart des routes nÃ©cessitent un token JWT valide
- **Validation** : Toutes les entrÃ©es sont validÃ©es avec Zod
- **Rate Limiting** : Limitation du nombre de requÃªtes par IP
- **Autorisation** : Certaines actions sont rÃ©servÃ©es aux administrateurs
- **Sandbox** : Puppeteer s'exÃ©cute en mode sandbox sÃ©curisÃ©

## Maintenance

### Nettoyage Automatique

```typescript
// Nettoyer les factures de plus de 30 jours
const result = await InvoiceService.cleanupOldInvoices();
console.log(`${result.data.deletedCount} factures supprimÃ©es`);
```

### Surveillance

```typescript
// Lister toutes les factures avec pagination
const result = await InvoiceService.listInvoices();
const { invoices, total, page, totalPages } = result.data;

// Filtrer par type
const pdfInvoices = invoices.filter((inv) => inv.type === 'PDF');
const htmlInvoices = invoices.filter((inv) => inv.type === 'HTML');
```

## DÃ©pannage

### ProblÃ¨mes Courants

1. **Erreur de permissions** : VÃ©rifier que le dossier `invoices` est accessible en Ã©criture
2. **Template manquant** : Le systÃ¨me crÃ©e automatiquement le template de base
3. **Facture non trouvÃ©e** : VÃ©rifier que l'abonnement existe et est actif
4. **Erreur Puppeteer** : VÃ©rifier que Puppeteer est installÃ© et configurÃ©
5. **Timeout PDF** : Augmenter les timeouts dans la configuration Puppeteer

### Logs

```typescript
import { logger } from '../utils/logger';

logger.info('Facture PDF gÃ©nÃ©rÃ©e avec succÃ¨s');
logger.error('Erreur lors de la gÃ©nÃ©ration de la facture PDF:', error);
```

## Exemples d'IntÃ©gration Frontend

### React Component

```tsx
import React, { useState } from 'react';

const InvoiceDownloader = ({ subscriptionId }: { subscriptionId: string }) => {
  const [loading, setLoading] = useState(false);
  const [format, setFormat] = useState<'pdf' | 'html'>('pdf');

  const downloadInvoice = async () => {
    setLoading(true);
    try {
      const response = await fetch(
        `/api/v1/invoices/${subscriptionId}/download?format=${format}`,
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
        }
      );

      if (response.ok) {
        if (format === 'pdf') {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `facture-${subscriptionId}.pdf`;
          a.click();
          window.URL.revokeObjectURL(url);
        } else {
          const html = await response.text();
          const blob = new Blob([html], { type: 'text/html' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `facture-${subscriptionId}.html`;
          a.click();
          window.URL.revokeObjectURL(url);
        }
      }
    } catch (error) {
      console.error('Erreur lors du tÃ©lÃ©chargement:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <select
        value={format}
        onChange={(e) => setFormat(e.target.value as 'pdf' | 'html')}
      >
        <option value='pdf'>PDF</option>
        <option value='html'>HTML</option>
      </select>
      <button onClick={downloadInvoice} disabled={loading}>
        {loading
          ? 'TÃ©lÃ©chargement...'
          : `TÃ©lÃ©charger en ${format.toUpperCase()}`}
      </button>
    </div>
  );
};

export default InvoiceDownloader;
```

### Vue.js Component

```vue
<template>
  <div>
    <select v-model="format">
      <option value="pdf">PDF</option>
      <option value="html">HTML</option>
    </select>
    <button @click="downloadInvoice" :disabled="loading">
      {{
        loading ? 'TÃ©lÃ©chargement...' : `TÃ©lÃ©charger en ${format.toUpperCase()}`
      }}
    </button>
  </div>
</template>

<script>
export default {
  props: {
    subscriptionId: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      loading: false,
      format: 'pdf',
    };
  },
  methods: {
    async downloadInvoice() {
      this.loading = true;
      try {
        const response = await fetch(
          `/api/v1/invoices/${this.subscriptionId}/download?format=${this.format}`,
          {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          }
        );

        if (response.ok) {
          if (this.format === 'pdf') {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facture-${this.subscriptionId}.pdf`;
            a.click();
            window.URL.revokeObjectURL(url);
          } else {
            const html = await response.text();
            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facture-${this.subscriptionId}.html`;
            a.click();
            window.URL.revokeObjectURL(url);
          }
        }
      } catch (error) {
        console.error('Erreur lors du tÃ©lÃ©chargement:', error);
      } finally {
        this.loading = false;
      }
    },
  },
};
</script>
```

## Support

Pour toute question ou problÃ¨me avec le systÃ¨me de factures, consultez :

- La documentation de l'API
- Les logs du serveur
- Le code source des services et contrÃ´leurs
- La configuration Puppeteer
- Les erreurs de gÃ©nÃ©ration PDF
